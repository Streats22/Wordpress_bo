"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};
/*!
* Copyright (C) Oh!Fuchs, if not stated otherwise
* Written by Patrick Paul, Oh!Fuchs, Apparelcuts <patrick@ohfuchs.com> 2015-2019
*/wp.hooks.addAction("sfw.register.plugins","sfw.plugin.sync",function(n,o){function s(e){var t=e/1e3,s=Math.floor(t%31536e3%86400/3600),r=Math.floor(t%31536e3%86400%3600/60),a=Math.floor(t%31536e3%86400%3600%60);return t<60?"less than a minute":1<s?n.sprintf(n.__("%1$s hours and %2$s minutes","apparelcuts-spreadshirt"),s,r):1==s?n.sprintf(n.__("one hour and %1$s minutes","apparelcuts-spreadshirt"),r):1<r?n.sprintf(n.__("%1$s minutes","apparelcuts-spreadshirt"),r):n.sprintf(n.__("one minute and %1$s seconds","apparelcuts-spreadshirt"),a)}var c=n.sync={},e=c.screen={};e.init=function(){var e=this;this.$startbutton=o("#sfw-sync-start.button"),this.$stopbutton=o("#sfw-sync-stop.button"),this.$startbutton.one("click",function(){e.$startbutton.addClass("disabled"),o("#mb-sync-stats,#mb-sync-log").removeClass("sfw-hidden"),c.run().always(function(){return e.$stopbutton.addClass("disabled")}),e.$stopbutton.removeClass("disabled").on("click",function(){c.forceStop=!0,e.$stopbutton.addClass("disabled")})}).removeClass("disabled"),wp.hooks.doAction("sfw.sync.init",n,o)},wp.hooks.addAction("sfw.ready","sfw.sync.screen.init",function(){return e.init()});var r=e.stage={};r.init=function(){r.$el=o("#sfw-stage"),r.default=r.$el.children()},wp.hooks.addAction("sfw.ready","sfw.sync.stage.init",r.init),r.show=function(e){this.clear(),this.$el.append(e)},r.clear=function(){this.$el.children().detach()},r.reset=function(){this.show(this.default)};var t=function(e){var s=this;this.$el=e,this.percentage=0,this.set=function(e,t){return s.setProgress(e),void 0!==t&&s.setLabel(t),s},this.setProgress=function(e){return e=Math.min(100,Math.max(0,e)),e=Math.ceil(100*e)/100,s.percentage=e,s.refreshUI(),s},this.setLabel=function(e){return s.label=e,s.refreshUI(),s},this.reset=function(){return s.resetProgress(),s.resetLabel(),s},this.resetProgress=function(){return s.setProgress(0)},this.resetLabel=function(){return s.setLabel("")},this.addProgress=function(e){return s.set(s.percentage+e)},this.add=function(e){return s.addProgress(e)},this.refreshUI=function(){this.$el.find(".-sfw-progress").css("width",this.percentage+"%"),this.$el.find(".-sfw-label").text(this.label)}},d=e.progressbars={};d.init=function(){d.primary=new t(o("#sfw-progress-primary")),d.secondary=new t(o("#sfw-progress-secondary"))},wp.hooks.addAction("sfw.ready","sfw.sync.progressbars.init",d.init),d.get=function(e){return this[e="primary"===e?e:"secondary"]};var i=e.stats={};i.init=function(){this.$box=o("#mb-sync-stats>.inside")},wp.hooks.addAction("sfw.ready","sfw.sync.stats.init",function(){return i.init()}),c.group=function(e){e=e||n.__("Other","apparelcuts-spreadshirt");var t=i.$box.find('[data-stats-group="'+e+'"]');return t.length||(t=o('<div data-stats-group="'+e+'" class=""></div>').append("<h4>"+e+"</h4>")).appendTo(i.$box),t},c.stat=i.update=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"-",s=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"",r=s+e,a=i.$box.find('[data-stats-label="'+r+'"]');a.length||(a=o('<div class="grid-x" data-stats-label="'+r+'"><div class="cell small-8 --label">'+e+'</div><div class="cell small-4 --value"></div></div>')).appendTo(this.group(s)),a.find(".--value").html(t)},c.registered_tasks={},c.registerTask=function(e,t){t=o.extend({},{handle:e,label:e,callback:null,dependencies:[],data:!1},t),this.registered_tasks[e]=t},c.queued_tasks=[],c.enqueueTask=function(e,t){this.queued_tasks.push(e),t&&c.registerTask(e,t)},c.getTask=function(e){return this.registered_tasks[e]||!1},c.addDependency=function(e,t){var s=this.getTask(e);s&&s.dependencies.push(t)},c.resolve_dependencies=function(e){var a=this.queue;e.forEach(function(e,t,s){if(!(0<=a.indexOf(e))){var r=c.getTask(e);r&&r.dependencies.length&&c.resolve_dependencies(r.dependencies),a.push(e)}})},c.create_queue=function(){return this.queue=[],this.resolve_dependencies(this.queued_tasks),this.queuesize=this.queue.length,this.queue},c.run=function(){return this.tasks_done=[],this.tasks_failed=[],this.runtime_errors=0,this.start=(new Date).getTime(),this.force_update=o("input#force_update").attr("disabled",!0).is(":checked"),d.get("primary").reset(),this.create_queue(),this.task_count=this.queue.length,this.forceStop=!1,this.synchronization_process=o.Deferred(),o("body").addClass("sfw-sync-running"),this.synchronization_process.always(function(){console.log(c.tasks_done.length+" Tasks completed."),console.log(c.tasks_failed.length+" Tasks failed."),c.tasks_failed.length&&c.stat(n.__("Failed Tasks","apparelcuts-spreadshirt"),n.sprintf("%1$s of %2$s",c.tasks_failed.length,c.task_count),n.__("Errors","apparelcuts-spreadshirt")),o("body").removeClass("sfw-sync-running")}).done(function(){var e="Synchronization finished after "+s((new Date).getTime()-c.start)+".";d.get("primary").set(100,e),console.log("%c"+e,"color:white;background:green;"),o("body").addClass("sfw-sync-success"),r.show('<span class="ac ac-shirt-check"></span>')}).fail(function(e){var t="Synchronization failed after "+s((new Date).getTime()-c.start)+". "+e.msg;d.get("primary").set(100,e.msg||""),console.error(t),o("body").addClass("sfw-sync-failed"),r.show('<span class="ac ac-shirt-o"></span>')}),this.runTask(),this.synchronization_process.promise()},c.stop=function(){var e=this;if(this.forceStop)return this.synchronization_process.reject({error:"stopped-manually",msg:n.__("Synchronization stopped manually","apparelcuts-spreadshirt")}),!0;n.api({route:"did-sync"}).always(function(){return e.synchronization_process.resolve()})},c.stopped=function(){return!!this.forceStop&&(c.stop(),!0)},c.runTask=function(){if(0!==this.queue.length){if(!this.stopped()){var r=this.queue.shift(),e=this.getTask(r),a=d.get("primary"),i=d.get("secondary"),t=o.Deferred(function(t){if(!e)return t.reject({error:"task-not-found",msg:'Skipping Task "'+r+'". Task not found.'});if("function"!=typeof e.callback)return t.reject({error:"task-not-callable",msg:'Skipping Task "'+r+'". Callback is not a function.'});var s=!1;return e.dependencies.forEach(function(e){-1===c.tasks_done.indexOf(e)&&(s=e)}),s?t.reject({error:"missing-task-dependency",msg:'Skipping Task "'+r+'". Missing dependency "'+s+'"'}):(a.setLabel(e.label),i.reset(),console.log('%cStarting Task "'+r+'"…',"color:#bbb;"),e.callback.call(null,i,c).then(function(e){return t.resolve(e)},function(e){return t.reject(e)}))});t.done(function(e){c.tasks_done.push(r),(e=e||[]).length?(c.stat(r,e.length,n.__("Errors","apparelcuts-spreadshirt")),console.error('Finished Task "'+r+'" with errors…',e)):console.log('%cFinished Task "'+r+'" without errors…',"color:#bbb;")}),t.fail(function(e){c.tasks_failed.push(r),console.error("Task failed: "+r,e)}),t.always(function(){i.set(100,""),a.set(c.tasks_failed.length+c.tasks_done.length/c.queuesize*100),c.screen.stage.reset(),c.runTask()})}}else c.stop()},c.dataStorage={},c.get=function(e,t){return void 0===t&&(t=!1),this.dataStorage[e]||t},c.set=function(e,t){this.dataStorage[e]=t}}),wp.hooks.addAction("sfw.sync.init","sfw.sync.tasks.proto",function(p,u){p.sync,p.InventoryTask=function(e,s,r){var a=this;return this.deferred=u.Deferred(),this.args=u.extend({offset:0,limit:500,url:!1,dataStorage:!1,root:!1,label_log:p.__("%1$s Items found","apparelcuts-spreadshirt"),stat_group:!1},e),this.data=[],this.errors=[],this.args.url?(this.request=function(){if(!s.stopped()){var e={method:"get",url:a.args.url,data:{fullData:"true",offset:a.args.offset,limit:a.args.limit,noCache:!0}};p.spreadshirt(e).done(function(e){var t=a.args.root?e[a.args.root]:e;a.data=a.data.concat(t),a.args.stat_group&&s.stat("Spreadshirt",a.data.length,a.args.stat_group),a.args.offset+=a.args.limit,a.args.offset<=e.count?(r.set(a.args.offset/e.count*100),setTimeout(a.request,p.get("remote_timeout",500))):(a.args.dataStorage&&s.set(a.args.dataStorage,a.data),console.log(p.sprintf(a.args.label_log,a.data.length)),a.deferred.resolve(a.errors,a.data))}).fail(function(e){a.deferred.reject({error:"request",msg:p.extractErrorMsg(e),data:e})})}},this.request(),this.deferred.promise()):this.deferred.reject({error:"missing-url",msg:"No proper url given."})},p.SyncingTask=function(e,a,i){var s=this,n=this;return this.deferred=u.Deferred(),this.args=u.extend({data:[],entity:null},e),this.queue=[],u.each(this.args.data,function(e,t){"object"===(void 0===t?"undefined":_typeof(t))&&t.id?s.queue.push(t):s.queue.push({id:t})}),this.total=this.queue.length,this.errors=[],this.queue.length?(this.request=function(){if(!a.stopped()){var e=n.queue.shift(),t=e.id;i.setLabel(p.__("Syncing...","apparelcuts-spreadshirt")+" "+t);try{if(e.resources)for(var s in e.resources)"preview"==e.resources[s].type&&a.screen.stage.show(u("<img/>").attr("src",e.resources[s].href+",width=50,height=50"))}catch(e){}var r={entity:n.args.entity,spreadshirt_id:t,force_update:a.force_update};p.api({route:"sync-item",data:r}).fail(function(e){n.errors.push(e),console.log(p.extractErrorMsg(e))}).always(function(){n.queue.length?(i.set((n.total-n.queue.length)/n.total*100),setTimeout(n.request,p.get("local_timeout",500))):n.deferred.resolve(n.errors)})}},this.request(),this.deferred.promise()):this.deferred.resolve(n.errors)},p.EntityInventoryTask=function(e,s,r){var a=this;return this.deferred=u.Deferred(),this.args=u.extend({entity:null,offset:0,limit:500,dataStorage:!1,label_log:p.__("%1$s Items found","apparelcuts-spreadshirt"),stat_group:!1},e),this.data=[],this.errors=[],this.request=function(){if(!s.stopped()){var e={route:"entity-list",data:{offset:a.args.offset,limit:a.args.limit,entity:a.args.entity}};p.api(e).done(function(e){var t=e.items;a.data=a.data.concat(t),a.args.stat_group&&s.stat("Wordpress",a.data.length,a.args.stat_group),a.args.offset+=a.args.limit,0==e.results||e.results<a.args.limit?(a.args.dataStorage&&s.set(a.args.dataStorage,a.data),console.log(p.sprintf(a.args.label_log,a.data.length)),a.deferred.resolve(a.errors,a.data)):(e.count&&r.set(a.args.offset/e.count*100),setTimeout(a.request,p.get("local_timeout",500)))}).fail(function(e){a.deferred.reject({error:"request",msg:p.extractErrorMsg(e),data:e})})}},this.request(),this.deferred.promise()},p.UpdateableEntityTask=function(e,t,s){function r(e){for(var t in i.args.remote_items)if(i.args.remote_items[t].id==e)return i.args.remote_items[t];return!1}function a(e){for(var t in i.args.database_items)if(i.args.database_items[t]["spreadshirt-id"]==e)return i.args.database_items[t];return!1}var i=this;this.deferred=u.Deferred(),this.args=u.extend({database_items:[],remote_items:[],dataStorage:!1,stat_group:!1},e),this.errors=[];var n={requires_action:[],remove_required:[],requires_no_action:0,update_required:0,update_forced:0,create_required:0};for(var o in this.args.remote_items)(c=a((d=this.args.remote_items[o]).id))?c.expired?(n.update_required++,n.requires_action.push(d)):t.force_update?(n.update_forced++,n.requires_action.push(d)):n.requires_no_action++:(n.create_required++,n.requires_action.push(d));for(var o in this.args.database_items){var c,d;(d=r((c=this.args.database_items[o])["spreadshirt-id"]))||n.remove_required.push(c)}return i.args.dataStorage&&t.set(i.args.dataStorage,n),i.args.stat_group&&(t.stat(p.__("New","apparelcuts-spreadshirt"),n.create_required,i.args.stat_group),t.stat(p.__("Update","apparelcuts-spreadshirt"),n.update_required,i.args.stat_group),t.force_update?t.stat(p.__("Update (forced)","apparelcuts-spreadshirt"),n.update_forced,i.args.stat_group):t.stat(p.__("No Action","apparelcuts-spreadshirt"),n.requires_no_action,i.args.stat_group),t.stat(p.__("Removed","apparelcuts-spreadshirt"),n.remove_required.length,i.args.stat_group)),this.deferred.resolve(this.errors,n)},p.TrashPostsTask=function(e,a,t){var i=this;return this.deferred=u.Deferred(),this.args=u.extend({posts:[],limit:10},e),this.errors=[],this.request=function(){var e=this;if(!a.stopped()){for(var t=[],s=0;s<i.args.limit;s++)i.args.posts.length&&t.push(i.args.posts.shift().id);var r={route:"trash-posts",data:{posts:t}};p.api(r).fail(function(e){i.errors.push(e)}).always(function(){0!=i.args.posts.length?setTimeout(i.request,p.get("local_timeout",500)):i.deferred.resolve(e.errors)})}},this.request(),this.deferred.promise()}}),wp.hooks.addAction("sfw.sync.init","sfw.sync.tasks.articles",function(d,p){var e=d.sync;e.registerTask("db-articles",{label:d.__("Syncing Database Articles","apparelcuts-spreadshirt"),dependencies:[],callback:function(e,t){return d.EntityInventoryTask({entity:"article",dataStorage:"db-articles",label_log:d.__("%1$s Articles found","apparelcuts-spreadshirt"),stat_group:d.__("Articles","apparelcuts-spreadshirt")},t,e)}}),e.registerTask("articles",{label:d.__("Syncing Shop Articles","apparelcuts-spreadshirt"),dependencies:[],callback:function(e,t){return d.InventoryTask({url:d.get("shop").articleCategories.href+"/510/articles",dataStorage:"articles",root:"articles",label_log:d.__("%1$s Articles found","apparelcuts-spreadshirt"),stat_group:d.__("Articles","apparelcuts-spreadshirt")},t,e)}}),e.registerTask("prepare-article-sync",{label:d.__("Preparing Article Updates","apparelcuts-spreadshirt"),dependencies:["db-articles","articles"],callback:function(e,t){return d.UpdateableEntityTask({database_items:t.get("db-articles",[]),remote_items:t.get("articles",[]),dataStorage:"prepared-articles",stat_group:d.__("Articles","apparelcuts-spreadshirt")},t,e)}}),e.enqueueTask("sync-articles",{label:d.__("Syncing Shop Articles","apparelcuts-spreadshirt"),dependencies:["prepare-article-sync"],callback:function(e,t){return d.SyncingTask({data:t.get("prepared-articles").requires_action,entity:"article"},t,e)}}),e.enqueueTask("article-cleanup",{label:d.__("Trashing Shop Articles","apparelcuts-spreadshirt"),dependencies:["prepare-article-sync","prepare-producttype-sync"],callback:function(e,t){var s=t.get("db-articles"),r=t.get("prepared-producttypes").remove_required,a=t.get("prepared-articles").remove_required,i={},n=p.Deferred();if(a&&a.length)for(var o in a)"publish"==a[o].post_status&&(i[a[o].id]=a[o]);if(r&&r.length)for(var o in r)if((a=d.filterObjectList(s,"producttype-id",r[o].id))&&a.length)for(var o in a)"publish"==a[o].post_status&&(i[a[o].id]=a[o]);if(!Object.keys(i).length)return n.resolve([]);var c=[];for(var o in i)c.push(i[o]);return d.TrashPostsTask({posts:c},t,e).done(function(e){return n.resolve(e)}).fail(function(e){return n.reject(e)}),n}})}),wp.hooks.addAction("sfw.sync.init","sfw.sync.tasks.producttypes",function(s,e){var t=s.sync;t.registerTask("db-producttypes",{label:s.__("Syncing Database Articles","apparelcuts-spreadshirt"),dependencies:[],callback:function(e,t){return s.EntityInventoryTask({entity:"producttype",dataStorage:"db-producttypes",label_log:s.__("%1$s Producttypes found","apparelcuts-spreadshirt"),stat_group:s.__("Producttypes","apparelcuts-spreadshirt")},t,e)}}),t.registerTask("producttypes",{label:s.__("Syncing Shop Producttypes","apparelcuts-spreadshirt"),dependencies:[],callback:function(e,t){return s.InventoryTask({url:s.get("shop").productTypes.href,dataStorage:"producttypes",root:"productTypes",label_log:s.__("%1$s ProductTypes found","apparelcuts-spreadshirt"),stat_group:s.__("Producttypes","apparelcuts-spreadshirt")},t,e)}}),t.registerTask("prepare-producttype-sync",{label:s.__("Preparing Producttype Updates","apparelcuts-spreadshirt"),dependencies:["db-producttypes","producttypes"],callback:function(e,t){return s.UpdateableEntityTask({database_items:t.get("db-producttypes",[]),remote_items:t.get("producttypes",[]),dataStorage:"prepared-producttypes",stat_group:s.__("Producttypes","apparelcuts-spreadshirt")},t,e)}}),t.registerTask("sync-producttypes",{label:s.__("Syncing Shop ProductTypes","apparelcuts-spreadshirt"),dependencies:["prepare-producttype-sync"],callback:function(e,t){return s.SyncingTask({data:t.get("prepared-producttypes").requires_action,entity:"producttype"},t,e)}})}),wp.hooks.addAction("sfw.sync.init","sfw.sync.tasks",function(s,e){var t=s.sync;t.registerTask("designs",{label:s.__("Syncing Shop Designs","apparelcuts-spreadshirt"),dependencies:[],callback:function(e,t){return s.InventoryTask({url:s.get("shop").designCategories.href+"/510/designs",dataStorage:"designs",root:"designs",label_log:s.__("%1$s Designs found","apparelcuts-spreadshirt"),stat_group:s.__("Designs","apparelcuts-spreadshirt")},t,e)}}),t.registerTask("sync-designs",{label:s.__("Syncing Shop Designs","apparelcuts-spreadshirt"),dependencies:["designs"],callback:function(e,t){return s.SyncingTask({data:t.get("designs",[]),entity:"design"},t,e)}}),t.registerTask("printtypes",{label:s.__("Syncing Shop PrintTypes","apparelcuts-spreadshirt"),dependencies:[],callback:function(e,t){return s.InventoryTask({url:s.get("shop").productTypes.href,dataStorage:"printtypes",root:"printTypes",label_log:s.__("%1$s PrintTypes found","apparelcuts-spreadshirt"),stat_group:s.__("Printtypes","apparelcuts-spreadshirt")},t,e)}}),t.registerTask("sync-printtypes",{label:s.__("Syncing Shop PrintTypes","apparelcuts-spreadshirt"),dependencies:["printtypes"],callback:function(e,t){return s.SyncingTask({data:t.get("printtypes",[]),entity:"printtype"},t,e)}})});